# perseus: a fail-slow detection framework for cloud storage systems

### 摘要

最近新出现的 fail-slow 问题困扰着硬件和软件系统，其特点是受影响的组件虽然仍然在运行，但性能已经明显下降。为了解决这个问题，文本提出 perseus，一个实践中的‘fail-slow’存储设备探测框架。perseus创新性的采用了基于轻量级回归分析的模型，能够在驱动器粒度上快速定位并分析慢速故障。在 10 个月的时间内，perseus监控了 24 万块盘，发现了 304 个 fail-slow 的问题。隔离这些设备可以把节点级别的4 个 9 尾延时响应时间减少减少 48%。我们基于生产环境数据构建了大规模慢数据故障集（包含 4 万个正常盘和 315 个验证的 fail-slow 盘），并据此对慢故障盘展开了根因分析，涵盖调度算法缺陷、硬件设计瑕疵及环境因素等多类成因。我们已经公开了这个数据集。

### 1 介绍

大规模的存储系统容易受到各种故障的影响。学术界和工业界已在故障识别，检测和修复领域取得显著进展，涵盖停机故障，局部故障以及拜占庭故障等多种类型。

近来，fail-slow故障，也被称为 gray-failure 或者 limpware，正受到越来越多的关注。在 fail-slow故障里，软件或硬件组件的实际性能会低于预期。随着硬件性能的提升（Optane SSD，ZNS SSD）和软件栈（用户态驱动）的优化，fail-slow故障正在变得越来越容易检测和识别。最近的研究表明，fail-slow故障的发生率和 fail-stop 的几率相当。

准确的探测fail-slow故障是很有挑战的。性能差异有可能是内部因素引起的（SSD盘内的 GC）或者是外部的因素（负载的突发）都会有跟 fail-slow故障相似的症状。和 fail-stop 故障有明确的标准（软件 crash，数据丢失）不同，确定 fail-slow故障一般都靠经验。此外，fail-slow往往都是暂时的，很难让工程师去分辨，更不用说复现和解析根因了。

尽管已经有人在探测 fail-slow故障上做了一些工作，这些工作在大范围的云环境下就显得比较不够实用和比较低效。首先，这些方法需要访问源代码或者需要软件适配，但云厂商并不会碰用户代码。即使是内部的基础设施，插入一些代码片段也是相当耗费时间的，这些系统有可能跑了非常不同软件栈的服务。其次，现有的这些技术只能探测到节点级别，仍然需要人工才能定位到最后的原因。

本文我们分享了一个实用的，细粒度且通用的fail-slow检测框架，该框架广泛用于阿里巴巴云数据中心的各类服务和设备（仅需少量调整或无需调整）。首先我们分析了fail-slow在设备集群中的特征表现。随后我们探索了三种在实际场景中识别fail-slow的尝试，包括：

1. 采用经验阈值
2. 基于peer评估
3. IASO系统的重构

从之前的工作中吸取经验，我们设计和实现了 PERSEUS，一种非侵入式的fail-slow检测框架。通过映射关系，PERSEUS 能够自动为每个节点衍生出一个精确的和自适应的阈值，在监控中判断慢速条目。进而，基于慢速条目，PERSEUS 构建了相应的fail-slow事件和利用一个记分板的机制去评估这些事件的严重程度。

PERSEUS已经部署在云环境中超过 10 个月了，监控了高速增长的硬盘数达到了 30w片。PERSEUS 已经发现了超过 300 个fail-slow盘。通过隔离或者替换发现的fail-slow盘，我们显著的降低了节点的尾延时。95 分位，99 分位，9999 分位写延时分别下降了 31% 46% 48%。

我们对比了 PERSEUS和之前的一些 fail-slow检测方法。并发布了一个来自于生产环境的数据集，包含了 315 个确认的 fail-slow故障和大约 41k个集群上其他的盘，并构建了一个测试的 benchmark。benchmark评估显示 PERSEUS 使用了前面的方法，得到了准确率 99，召回率 100。我们也评估了 PERSEUS中组件的有效性和参数的敏感程度。结果显示，PERSEUS可以作为一个非侵入式的（基于监控日志），细粒度的（盘粒度），通用的（一组参数适用于所有场景）和准确的（高准确率和召回率）云计算存储系统的fail-slow检测框架。

我们对 fail-slow的成因进行了深入分析，发现其根本原因呈现多样化特征，主要包括以下几类：

1. 调度机制缺陷：资源争用等非必要调度问题
2. 硬件固有缺陷：以磁盘坏道为代表的物理层故障
3. 环境干扰因素：温度波动和电力供应异常

本文做了以下的工作：

1. 我们分享了在大规模数据中心做 fail-slow检测的三种失败的尝试
2. 提出了 PERSEUS的设计，一个非侵入式的，细粒度的，通用的 fail-slow检测框架
3. 我们组装了一个大规模的 fail-slow数据集，构建了一个 fail-slow测试 benchmark
4. 我们提供了一个 fail-slow多个角度的深入根因分析

### 2 背景

#### 2.1 系统架构

在本文，我们探索了在 alibaba 数据中心 做fail-slow的检测方法。这些 IDC 遍布于全球，每个IDC都包含了多个存储集群。在每个集群上都部署了一套分布式文件系统，用于支持一些特定的服务（比如块存储，NoSQL 或者大数据分析等）。每个集群都包含了技术个 rack ，最多有 200 个，每个 rack 包含几十个节点（最多 48 个）。
